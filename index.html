<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BareVault Object Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1400.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        minio: {
                            bg: '#0a0f1c',
                            panel: '#111827',
                            sidebar: '#0f1423',
                            border: '#1f2937',
                            accent: '#ef4444',
                            text: '#d1d5db'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-minio-bg text-minio-text font-sans h-[100dvh] flex overflow-hidden">

    <div id="globalLoader"
        class="absolute inset-0 z-[100] flex flex-col items-center justify-center bg-minio-bg transition-opacity duration-300">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-minio-accent mb-4"></div>
        <p class="text-sm text-gray-400 font-medium animate-pulse">Establishing secure connection...</p>
    </div>

    <div id="createBucketModal" class="absolute inset-0 z-[300] hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-minio-panel border border-minio-border p-6 rounded-lg max-w-md w-full shadow-2xl m-4">
            <h2 class="text-xl font-bold text-white mb-4">Create New Bucket</h2>
            <div class="mb-5">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Bucket Name</label>
                <input type="text" id="newBucketName" oninput="validateBucketName()" class="w-full bg-[#0a0f1c] border border-minio-border rounded-md p-3 text-sm text-white focus:border-indigo-500 focus:outline-none transition-colors shadow-sm" placeholder="e.g. my-app-data">
                <p id="bucketValidationMsg" class="text-xs text-gray-500 mt-2 flex items-start"></p>
            </div>
            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-800">
                <button onclick="closeCreateBucketModal()" class="px-4 py-2 rounded text-sm font-medium text-gray-400 hover:text-white transition-colors">Cancel</button>
                <button id="confirmCreateBucketBtn" onclick="submitCreateBucket()" disabled class="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed text-white rounded text-sm font-bold transition-colors shadow-lg">Create Bucket</button>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="absolute inset-0 z-[300] hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="bg-minio-panel border border-minio-border p-6 rounded-lg max-w-lg w-full shadow-2xl m-4 flex flex-col max-h-[90vh]">
            <h2 class="text-xl font-bold text-white mb-5 shrink-0">Generate Team Invite</h2>
            
            <div class="overflow-y-auto flex-1 pr-2 space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Max Uses</label>
                    <div class="flex items-center bg-[#0a0f1c] border border-minio-border rounded-md overflow-hidden focus-within:border-indigo-500 transition-colors shadow-sm">
                        <button onclick="decrementUses()" class="px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 transition-colors flex items-center justify-center border-r border-minio-border">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                        </button>
                        <input type="number" id="inviteMaxUses" value="5" min="1" class="flex-1 w-full bg-transparent py-2.5 px-3 text-sm text-center text-white focus:outline-none appearance-none m-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                        <button onclick="incrementUses()" class="px-4 py-3 text-gray-400 hover:text-white hover:bg-gray-800 transition-colors flex items-center justify-center border-l border-minio-border">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Permission Level</label>
                    <div class="relative">
                        <select id="invitePolicy" class="appearance-none w-full bg-[#0a0f1c] border border-minio-border rounded-md py-3 pl-3 pr-10 text-sm text-white focus:border-indigo-500 focus:outline-none transition-colors cursor-pointer shadow-sm">
                            <option value="readonly" selected>Read Only (View & Download)</option>
                            <option value="readwrite">Read & Write (Standard)</option>
                            <option value="admin">Admin (Full Control)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide">Bucket Access</label>
                        <label class="flex items-center text-xs text-indigo-400 cursor-pointer hover:text-indigo-300 font-bold">
                            <input type="checkbox" id="selectAllBuckets" onchange="toggleAllInviteBuckets(this)" class="mr-2 h-4 w-4 rounded border-gray-600 bg-[#0a0f1c] text-indigo-500 cursor-pointer">
                            Select All
                        </label>
                    </div>
                    <div id="inviteBucketList" class="bg-[#0a0f1c] border border-minio-border rounded-md p-2 max-h-48 overflow-y-auto space-y-1 shadow-inner"></div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6 shrink-0 pt-4 border-t border-gray-800">
                <button onclick="closeInviteModal()" class="px-4 py-2 rounded text-sm font-medium text-gray-400 hover:text-white transition-colors">Cancel</button>
                <button onclick="submitGenerateInvite()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded text-sm font-bold transition-colors shadow-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Copy Link
                </button>
            </div>
        </div>
    </div>

    <div id="previewModal" class="absolute inset-0 z-[200] hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="w-full max-w-6xl h-full max-h-[90vh] flex flex-col bg-minio-panel rounded-lg shadow-2xl border border-minio-border overflow-hidden m-4">
            <div class="p-4 border-b border-minio-border flex justify-between items-center bg-minio-sidebar shrink-0">
                <div class="flex items-center text-sm font-bold text-white truncate px-2">
                    <span id="previewTitle" class="truncate flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3 text-indigo-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Preview
                    </span>
                </div>
                <button onclick="closePreview()" class="text-gray-400 hover:text-white bg-gray-800/50 hover:bg-gray-700 p-2 rounded-md transition-colors flex items-center">
                    <span class="text-xs font-bold mr-2 uppercase tracking-wide">Close</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 w-full h-full bg-[#050811] flex items-center justify-center p-2 relative overflow-hidden">
                <img id="previewImage" class="hidden max-w-full max-h-full object-contain" src="" alt="Preview">
                <iframe id="previewFrame" class="hidden w-full h-full rounded border-none bg-white/5" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <div id="teamModal" class="absolute inset-0 z-[250] hidden flex-col items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity">
        <div class="w-full max-w-4xl bg-minio-panel rounded-lg shadow-2xl border border-minio-border overflow-hidden m-4">
            <div class="p-4 border-b border-minio-border flex justify-between items-center bg-minio-sidebar shrink-0">
                <h2 class="text-sm font-bold text-white flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-indigo-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Manage Team Access
                </h2>
                <button onclick="document.getElementById('teamModal').classList.add('hidden')" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-0 max-h-[60vh] overflow-y-auto">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead class="text-[10px] uppercase bg-gray-800 text-gray-400 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 font-bold tracking-wider">Employee Name</th>
                            <th class="px-6 py-3 font-bold tracking-wider">Role</th>
                            <th class="px-6 py-3 font-bold tracking-wider">Access Key</th>
                            <th class="px-6 py-3 text-right font-bold tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="absolute inset-0 z-50 flex flex-col lg:flex-row w-full h-full bg-minio-bg hidden">
        <div class="hidden lg:flex flex-col justify-center w-1/2 p-16 border-r border-minio-border relative overflow-hidden">
            <h1 class="text-4xl font-bold text-white mb-4">High-Performance Object Store</h1>
            <p class="text-sm text-gray-400 leading-relaxed max-w-md z-10">
                BareVault is a cloud-native object store built to run on any infrastructure - public, private or edge
                clouds. Primary use cases include mobile applications, SaaS, and fast backup & recovery.
            </p>
            <div class="absolute bottom-0 left-0 w-full h-1/2 opacity-20 bg-gradient-to-t from-blue-500 to-transparent"></div>
        </div>

        <div class="flex flex-col justify-center items-center w-full lg:w-1/2 p-8 bg-minio-panel">
            <div class="w-full max-w-sm">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-black text-white tracking-wider">BARE<span class="text-minio-accent">VAULT</span></h2>
                    <span class="inline-block mt-2 bg-slate-800 text-xs font-bold px-2 py-1 rounded text-gray-300 border border-slate-600">Universal Client Portal</span>
                </div>

                <div class="space-y-4">
                    <div><input type="text" id="endpointUrl" placeholder="API Endpoint" class="w-full bg-[#0a0f1c] border border-minio-border rounded p-3 text-sm text-white focus:border-minio-accent focus:outline-none transition-colors"></div>
                    <div><input type="text" id="accessKey" placeholder="Access Key" class="w-full bg-[#0a0f1c] border border-minio-border rounded p-3 text-sm text-white focus:border-minio-accent focus:outline-none transition-colors"></div>
                    <div class="relative">
                        <input type="password" id="secretKey" placeholder="Secret Key" class="w-full bg-[#0a0f1c] border border-minio-border rounded p-3 text-sm text-white focus:border-minio-accent focus:outline-none transition-colors pr-12">
                        <button onclick="togglePassword()" class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 hover:text-gray-300 focus:outline-none">
                            <svg id="eyeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <button onclick="authenticate()" class="w-full bg-gray-200 hover:bg-white text-gray-900 font-bold py-3 rounded text-sm transition-colors mt-4">Login</button>
                    <p id="loginError" class="text-red-400 text-xs text-center mt-2 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardScreen" class="hidden w-full h-full flex">
        <div class="w-64 bg-minio-sidebar border-r border-minio-border flex flex-col justify-between shrink-0">
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-minio-border">
                    <h2 class="text-xl font-black text-white tracking-wider">BARE<span class="text-minio-accent">VAULT</span></h2>
                </div>

                <div id="adminActions" class="p-4 flex-1 flex flex-col overflow-hidden">
                    <div class="mb-2"><input type="text" id="bucketSearch" oninput="filterBuckets()" placeholder="Filter Buckets" class="w-full bg-[#0a0f1c] text-white border border-minio-border rounded p-2 text-xs focus:outline-none focus:border-gray-500"></div>
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 mt-4">Buckets</div>
                    <ul id="bucketListSidebar" class="space-y-1 overflow-y-auto flex-1"></ul>
                </div>
            </div>

            <div class="p-4 border-t border-minio-border space-y-2 shrink-0 pb-8 overflow-y-auto">
                <div id="adminTeamAction"></div>
                <button onclick="logout()" class="w-full text-left text-xs font-medium text-gray-400 hover:text-white flex items-center p-2 rounded hover:bg-minio-panel transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>    
                    Sign Out
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-minio-bg overflow-hidden">
            <div class="h-14 border-b border-minio-border flex items-center justify-between px-6 shrink-0">
                <h2 class="text-sm font-bold text-white tracking-wide">Object Browser</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="objectSearch" oninput="filterObjects()" placeholder="Start typing to filter..." class="bg-[#0a0f1c] border text-white border-minio-border rounded-md p-1.5 pl-8 text-xs w-72 focus:outline-none focus:border-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5 absolute left-2.5 top-2 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    </div>
                </div>
            </div>

            <div class="flex-1 flex flex-row overflow-hidden">
                <div class="flex-1 flex flex-col p-6 overflow-hidden">
                    <div class="bg-minio-panel border border-minio-border rounded-lg flex flex-col h-full overflow-hidden shadow-lg">
                        <div class="p-4 border-b border-minio-border flex justify-between items-center shrink-0">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                                <div>
                                    <span id="currentBucketName" class="font-bold text-white text-base">Select a bucket</span>
                                    <div class="text-[10px] text-gray-500 mt-0.5"><span id="bucketStats">Access: PRIVATE</span></div>
                                </div>
                            </div>
                            <div id="bucketToolbar" class="flex space-x-2">
                                <button onclick="refreshCurrentBucket()" class="bg-transparent border border-minio-border hover:bg-gray-800 text-gray-300 px-3 py-1.5 rounded text-xs font-medium transition-colors flex items-center">
                                    Refresh
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                                </button>
                            </div>
                        </div>
                        <div id="uploadProgressContainer" class="hidden w-full h-1 bg-minio-sidebar shrink-0"><div id="uploadProgressBar" class="h-full bg-minio-accent w-0 transition-all duration-200"></div></div>
                        <div class="grid grid-cols-12 gap-4 p-3 border-b border-minio-border text-[11px] font-bold text-gray-400 uppercase tracking-wide bg-[#0f1423]">
                            <div class="col-span-1 text-center"><input type="checkbox" id="selectAllCheckbox" onclick="toggleAllFiles(this)" class="bg-transparent border-gray-600 rounded"></div>
                            <div class="col-span-6 flex items-center">Name</div>
                            <div class="col-span-3">Last Modified</div>
                            <div class="col-span-2 text-right">Size</div>
                        </div>
                        <div id="objectList" class="flex-1 overflow-y-auto"></div>
                    </div>
                </div>
                <div id="objectDetailsDrawer" class="hidden w-[340px] border-l border-minio-border bg-minio-sidebar flex flex-col overflow-y-auto shrink-0 z-10">
                    <div class="p-4 border-b border-minio-border flex justify-between items-center sticky top-0 bg-minio-sidebar">
                        <span id="drawerFileName" class="text-xs font-bold text-white truncate flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 text-indigo-400 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            <span id="drawerFileNameText" class="truncate"></span>
                        </span>
                        <button onclick="closeDrawer()" class="text-gray-400 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div class="p-5 space-y-6 flex-1">
                        <div id="drawerActionsContainer"></div>
                        <div class="pt-2">
                            <h3 class="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center justify-between">
                                Object Info
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                            </h3>
                            <div id="objectInfoFields" class="space-y-4 text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-[300] flex flex-col gap-3 pointer-events-none"></div>

    <script>
        let s3 = null;
        let activeBucket = '';
        let userRole = 'employee'; 
        let selectedObjectKey = '';
        let selectedFiles = new Set();

        const getToastIcon = (type) => {
            if(type === 'loading') return `<svg class="animate-spin w-4 h-4 mr-3 text-indigo-400" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            if(type === 'success') return `<svg class="w-4 h-4 mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            if(type === 'error') return `<svg class="w-4 h-4 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            return '';
        };

        function showToast(id, message, type = 'loading', autoDismiss = false) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = 'bg-minio-sidebar border border-minio-border text-gray-300 px-5 py-3 rounded shadow-2xl text-xs font-bold min-w-[280px] transition-opacity duration-300 flex items-center';
            toast.innerHTML = `${getToastIcon(type)} <span>${message}</span>`;
            container.appendChild(toast);
            if (autoDismiss) setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function updateToast(id, message, autoDismiss = false, type = 'success') {
            const toast = document.getElementById(id);
            if (toast) { toast.innerHTML = `${getToastIcon(type)} <span>${message}</span>`; if (autoDismiss) setTimeout(() => { toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 4000); }
        }

        function togglePassword() { const input = document.getElementById('secretKey'); input.type = input.type === 'password' ? 'text' : 'password'; }

        async function resolveEndpoint(url) {
            if (!url.includes(".workers.dev")) return url;
            try {
                const res = await fetch(new URL(url).origin + "/?resolve=true", { method: 'GET' });
                return res.ok ? (await res.text()).trim() : null;
            } catch (e) { return null; }
        }

        window.onload = async function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('invite') && urlParams.get('gateway')) { await redeemInvite(urlParams.get('invite'), urlParams.get('gateway')); return; }
            const savedEndpoint = localStorage.getItem('bv_endpoint');
            const savedAccess = localStorage.getItem('bv_access');
            const savedSecret = localStorage.getItem('bv_secret');
            if (savedEndpoint && savedAccess && savedSecret) {
                const activeEndpoint = await resolveEndpoint(savedEndpoint);
                if (activeEndpoint) { initAWS(activeEndpoint, savedAccess, savedSecret); return; }
            }
            document.getElementById('globalLoader').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        };

        function initAWS(endpoint, access, secret) {
            userRole = access.startsWith('bv_admin_') ? 'admin' : 'employee';
            
            // üîí UI HARD LOCK: Remove Admin/Write buttons from DOM if not Admin
            const adminActions = document.getElementById('adminActions');
            if (userRole === 'admin') {
                adminActions.insertAdjacentHTML('afterbegin', `
                    <button id="btnCreateBucket" onclick="openCreateBucketModal()" class="w-full bg-minio-panel border border-minio-border hover:bg-gray-800 text-white font-medium py-2 px-4 rounded flex items-center justify-center mb-2 text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Create Bucket
                    </button>
                    <button id="btnGenerateInvite" onclick="openInviteModal()" class="w-full bg-transparent border border-minio-border hover:bg-gray-800 text-gray-300 font-medium py-2 px-4 rounded flex items-center justify-center mb-6 text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" /></svg> Team Invite Link
                    </button>
                `);
                document.getElementById('adminTeamAction').innerHTML = `<button onclick="openTeamManager()" class="w-full text-left text-xs font-medium text-gray-400 hover:text-white flex items-center p-2 rounded hover:bg-minio-panel transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg> Manage Team</button>`;
                document.getElementById('bucketToolbar').insertAdjacentHTML('beforeend', `<input type="file" id="fileUploadInput" class="hidden" multiple onchange="uploadFiles(event)"><button id="btnUpload" onclick="document.getElementById('fileUploadInput').click()" class="bg-white hover:bg-gray-200 text-gray-900 px-4 py-1.5 rounded text-xs font-bold transition-colors flex items-center shadow-sm">Upload <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg></button><button id="btnDeleteBucket" onclick="deleteCurrentBucket()" class="bg-transparent border border-red-900/40 text-red-500 hover:bg-red-900/20 px-3 py-1.5 rounded text-xs font-bold transition-colors flex items-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3.5 h-3.5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg> Delete</button>`);
            }

            AWS.config.update({ accessKeyId: access, secretAccessKey: secret, region: 'us-east-1', s3ForcePathStyle: true, endpoint: new AWS.Endpoint(endpoint) });
            s3 = new AWS.S3();
            fetchBuckets(true);
        }

        function fetchBuckets(isInitialLoad = false) {
            s3.listBuckets(function (err, data) {
                document.getElementById('globalLoader').classList.add('hidden');
                if (err) { showError("AWS ERROR: " + err.message); return; }
                
                document.getElementById('dashboardScreen').classList.remove('hidden');
                const list = document.getElementById('bucketListSidebar');
                list.innerHTML = '';
                
                let visibleBuckets = 0;
                data.Buckets.forEach(b => {
                    // üõ°Ô∏è SIDEBAR ISOLATION: Employees only see buckets they can actually LIST objects in
                    if (userRole === 'admin') {
                        renderSidebarBucket(b.Name, list, isInitialLoad, ++visibleBuckets);
                    } else {
                        s3.listObjectsV2({ Bucket: b.Name, MaxKeys: 1 }, function(lErr) {
                            if (!lErr) {
                                renderSidebarBucket(b.Name, list, isInitialLoad, ++visibleBuckets);
                            }
                        });
                    }
                });
            });
        }

        function renderSidebarBucket(name, listElement, isInitialLoad, count) {
            listElement.insertAdjacentHTML('beforeend', `
                <li data-bucket="${name.toLowerCase()}" class="bucket-item">
                    <button id="bucket-btn-${name}" onclick="loadObjects('${name}')" class="bucket-btn w-full text-left px-3 py-1.5 text-sm text-gray-400 hover:text-white hover:bg-minio-panel rounded transition-colors truncate flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 text-gray-500 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                        <span class="truncate">${name}</span>
                    </button>
                </li>
            `);
            if (isInitialLoad && count === 1) loadObjects(name);
        }

        function loadObjects(bucketName) {
            activeBucket = bucketName;
            selectedFiles.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            closeDrawer();
            document.getElementById('currentBucketName').innerText = bucketName;
            document.querySelectorAll('.bucket-btn').forEach(btn => btn.classList.remove('bg-gray-800', 'text-white'));
            const activeBtn = document.getElementById('bucket-btn-' + bucketName);
            if (activeBtn) activeBtn.classList.add('bg-gray-800', 'text-white');

            const objList = document.getElementById('objectList');
            objList.innerHTML = '<div class="p-8 text-center text-sm text-gray-500 animate-pulse">Loading objects...</div>';

            s3.listObjectsV2({ Bucket: bucketName }, function (err, data) {
                if (err) { objList.innerHTML = `<div class="p-8 text-center text-sm text-red-400">Access Denied</div>`; return; }
                if (data.Contents.length === 0) { objList.innerHTML = '<div class="p-8 text-center text-sm text-gray-500">Bucket is empty.</div>'; return; }
                
                let html = '';
                data.Contents.forEach(obj => {
                    const size = (obj.Size / 1024).toFixed(1) + ' KiB';
                    html += `<div onclick="handleRowClick(event, this)" data-key="${obj.Key}" data-size="${size}" data-date="${new Date(obj.LastModified).toLocaleString()}" data-etag="${obj.ETag}" class="object-row grid grid-cols-12 gap-4 p-3 border-b border-minio-border text-sm text-gray-300 hover:bg-gray-800 transition-colors cursor-pointer group">
                        <div class="col-span-1 text-center" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleFileSelection('${obj.Key}', this.checked)" class="file-checkbox bg-transparent border-gray-600 rounded cursor-pointer"></div>
                        <div class="col-span-6 flex items-center truncate">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 text-indigo-400 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            <span class="truncate">${obj.Key}</span>
                        </div>
                        <div class="col-span-3 text-gray-500 text-[11px] flex items-center truncate">${new Date(obj.LastModified).toLocaleString()}</div>
                        <div class="col-span-2 text-right text-gray-500 text-[11px] flex items-center justify-end">${size}</div>
                    </div>`;
                });
                objList.innerHTML = html;
            });
        }

        function handleRowClick(event, element) {
            if (event && event.target.tagName.toLowerCase() === 'input') return;

            const key = element.getAttribute('data-key');
            document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
            const cb = element.querySelector('.file-checkbox');
            if (cb) cb.checked = true;
            selectedFiles.clear(); selectedFiles.add(key);

            // üõ°Ô∏è ACTION LOCK: Employees do NOT get the Delete button in the drawer
            let actionsHtml = `
                <button onclick="downloadSelected()" class="w-full text-left px-4 py-2.5 text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white flex items-center border-b border-minio-border">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 mr-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> Download
                </button>
                <button onclick="shareSelected()" class="w-full text-left px-4 py-2.5 text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white flex items-center border-b border-minio-border">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 mr-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 103.935 2.186 2.25 2.25 0 00-3.935-2.186zm0-12.814a2.25 2.25 0 103.933-2.185 2.25 2.25 0 00-3.933 2.185z" /></svg> Share
                </button>
                <button onclick="previewSelected()" class="w-full text-left px-4 py-2.5 text-xs font-medium text-gray-300 hover:bg-gray-800 hover:text-white flex items-center border-b border-minio-border">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 mr-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Preview
                </button>
            `;
            
            if (userRole === 'admin') {
                actionsHtml += `<button onclick="deleteSelected()" class="w-full mt-3 px-4 py-2.5 text-xs text-red-500 border border-red-900/40 hover:bg-red-900/20 rounded-md font-medium flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3.5 h-3.5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg> Delete</button>`;
            }

            document.getElementById('drawerActionsContainer').innerHTML = `<h3 class="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-3">Actions:</h3><div class="border border-minio-border rounded-md bg-minio-bg overflow-hidden">${actionsHtml}</div>`;
            
            document.getElementById('objectInfoFields').innerHTML = `
                <div><span class="block text-gray-400 mb-1 font-medium">Name:</span><span class="text-gray-200 break-all">${key}</span></div>
                <div><span class="block text-gray-400 mb-1 font-medium">Size:</span><span class="text-gray-200">${element.getAttribute('data-size')}</span></div>
                <div><span class="block text-gray-400 mb-1 font-medium">Last Modified:</span><span class="text-gray-200">${element.getAttribute('data-date')}</span></div>
                <div><span class="block text-gray-400 mb-1 font-medium">ETAG:</span><span class="text-gray-400 break-all font-mono text-[10px]">${element.getAttribute('data-etag')}</span></div>
            `;
            
            document.getElementById('drawerFileNameText').innerText = key;
            document.getElementById('objectDetailsDrawer').classList.remove('hidden');
        }

        function updateDrawerForSelection() {
            if (selectedFiles.size > 1) {
                document.getElementById('objectDetailsDrawer').classList.remove('hidden');
                document.getElementById('drawerFileNameText').innerText = `${selectedFiles.size} items selected`;

                let actionsHtml = `<button onclick="downloadBulk()" class="w-full text-left px-4 py-3 text-xs font-bold text-gray-300 hover:bg-gray-800 hover:text-white transition-colors flex items-center border-b border-minio-border"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-3 text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> Download ${selectedFiles.size} Files</button>`;
                
                if (userRole === 'admin') {
                    actionsHtml += `<button onclick="deleteBulk()" class="w-full mt-3 px-4 py-3 text-xs text-red-500 border border-red-900/40 hover:bg-red-900/20 rounded-md font-bold transition-colors flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg> Delete Selected</button>`;
                }

                document.getElementById('drawerActionsContainer').innerHTML = `<h3 class="text-[11px] font-bold text-gray-400 uppercase tracking-widest mb-3">Bulk Actions:</h3><div class="border border-minio-border rounded-md bg-minio-bg overflow-hidden">${actionsHtml}</div>`;
                document.getElementById('objectInfoFields').innerHTML = '';
            } else if (selectedFiles.size === 1) {
                const key = Array.from(selectedFiles)[0];
                const row = document.querySelector(`[data-key="${key}"]`);
                handleRowClick(null, row);
            } else {
                closeDrawer();
            }
        }

        // --- BUCKET VALIDATION & MODALS ---
        function validateBucketName() {
            const input = document.getElementById('newBucketName').value;
            const btn = document.getElementById('confirmCreateBucketBtn');
            const msg = document.getElementById('bucketValidationMsg');
            
            const infoIcon = `<svg class="w-3.5 h-3.5 mr-1.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            const errorIcon = `<svg class="w-3.5 h-3.5 mr-1.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
            const successIcon = `<svg class="w-3.5 h-3.5 mr-1.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;

            const isValidFormat = /^[a-z0-9][a-z0-9.-]*[a-z0-9]$/.test(input) && !input.includes('..');
            
            if (input.length === 0) {
                msg.innerHTML = `${infoIcon} Enter a bucket name to continue.`;
                msg.className = "text-xs text-gray-500 mt-2 flex items-start";
                btn.disabled = true;
            } else if (input.length < 3) {
                msg.innerHTML = `${errorIcon} Bucket name must be at least 3 characters.`;
                msg.className = "text-xs text-red-400 mt-2 flex items-start";
                btn.disabled = true;
            } else if (input.length > 63) {
                msg.innerHTML = `${errorIcon} Bucket name cannot exceed 63 characters.`;
                msg.className = "text-xs text-red-400 mt-2 flex items-start";
                btn.disabled = true;
            } else if (!isValidFormat) {
                msg.innerHTML = `${errorIcon} Use only lowercase letters, numbers, and non-consecutive hyphens.`;
                msg.className = "text-xs text-red-400 mt-2 flex items-start";
                btn.disabled = true;
            } else {
                msg.innerHTML = `${successIcon} Bucket name is valid!`;
                msg.className = "text-xs text-green-400 mt-2 flex items-start";
                btn.disabled = false;
            }
        }

        function openCreateBucketModal() { document.getElementById('newBucketName').value = ''; validateBucketName(); document.getElementById('createBucketModal').classList.replace('hidden', 'flex'); setTimeout(() => document.getElementById('newBucketName').focus(), 100); }
        function closeCreateBucketModal() { document.getElementById('createBucketModal').classList.replace('flex', 'hidden'); }
        function openInviteModal() { 
            const list = document.getElementById('inviteBucketList'); list.innerHTML = '';
            document.querySelectorAll('.bucket-item').forEach(i => {
                const n = i.getAttribute('data-bucket');
                list.insertAdjacentHTML('beforeend', `<label class="flex items-center text-sm text-gray-300 hover:text-white cursor-pointer p-2 rounded hover:bg-gray-800 transition-colors"><input type="checkbox" value="${n}" class="invite-bucket-cb mr-3 h-4 w-4 rounded border-gray-600 bg-transparent text-indigo-500 cursor-pointer" ${n === activeBucket ? 'checked' : ''}>${n}</label>`);
            });
            document.getElementById('inviteMaxUses').value = 5; document.getElementById('invitePolicy').value = 'readwrite'; document.getElementById('selectAllBuckets').checked = false;
            document.getElementById('inviteModal').classList.replace('hidden', 'flex'); 
        }
        function closeInviteModal() { document.getElementById('inviteModal').classList.replace('flex', 'hidden'); }
        function incrementUses() { document.getElementById('inviteMaxUses').stepUp(); }
        function decrementUses() { document.getElementById('inviteMaxUses').stepDown(); }
        function toggleAllInviteBuckets(cb) { document.querySelectorAll('.invite-bucket-cb').forEach(i => i.checked = cb.checked); }

        async function submitGenerateInvite() {
            const buckets = Array.from(document.querySelectorAll('.invite-bucket-cb:checked')).map(c => c.value);
            const policy = document.getElementById('invitePolicy').value;
            if (buckets.length === 0 && policy !== 'admin') { 
                showToast('err-inv', 'Please select at least one bucket.', 'error', true); 
                return; 
            }

            const res = await fetch(localStorage.getItem('bv_endpoint').replace('-api', '-admin') + '/api/invite/create', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('bv_secret'), 'Content-Type': 'application/json' },
                body: JSON.stringify({ max_uses: parseInt(document.getElementById('inviteMaxUses').value), policy: policy, buckets: buckets })
            });
            if (res.ok) { 
                const data = await res.json();
                navigator.clipboard.writeText(window.location.origin + window.location.pathname + "?invite=" + data.invite_token + "&gateway=" + encodeURIComponent(localStorage.getItem('bv_endpoint')));
                showToast('inv-success', 'Invite link copied!', 'success', true);
                closeInviteModal();
            }
        }

        async function uploadFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            document.getElementById('uploadProgressContainer').classList.remove('hidden');
            for (let i = 0; i < files.length; i++) {
                document.getElementById('currentBucketName').innerText = `Uploading ${i + 1}/${files.length}...`;
                const uploadRequest = s3.upload({ Bucket: activeBucket, Key: files[i].name, Body: files[i], ContentType: files[i].type || 'application/octet-stream' });
                uploadRequest.on('httpUploadProgress', evt => document.getElementById('uploadProgressBar').style.width = Math.round((evt.loaded * 100) / evt.total) + '%');
                await uploadRequest.promise().catch(err => showToast('up-err', "Upload Failed: " + err.message, 'error', true));
            }
            event.target.value = '';
            document.getElementById('uploadProgressContainer').classList.add('hidden'); document.getElementById('uploadProgressBar').style.width = '0%';
            loadObjects(activeBucket);
        }

        function submitCreateBucket() {
            const bucketName = document.getElementById('newBucketName').value.trim();
            document.getElementById('confirmCreateBucketBtn').disabled = true;
            s3.createBucket({ Bucket: bucketName }, function (err, data) {
                if (err) { showToast('cb-err', "Failed: " + err.message, 'error', true); document.getElementById('confirmCreateBucketBtn').disabled = false; } 
                else { activeBucket = bucketName; closeCreateBucketModal(); fetchBuckets(); }
            });
        }

        function deleteCurrentBucket() {
            if (!confirm(`Permanently delete bucket "${activeBucket}"?`)) return;
            s3.deleteBucket({ Bucket: activeBucket }, function (err, data) {
                if (err) showToast('db-err', "Delete Failed: " + err.message, 'error', true); 
                else { activeBucket = ''; fetchBuckets(true); }
            });
        }

        function deleteBulk() {
            if (!confirm(`Permanently delete selected items?`)) return;
            s3.deleteObjects({ Bucket: activeBucket, Delete: { Objects: Array.from(selectedFiles).map(Key => ({ Key })), Quiet: false } }, function (err, data) {
                if (err) showToast('dbulk-err', "Delete Failed: " + err.message, 'error', true); 
                else { selectedFiles.clear(); closeDrawer(); refreshCurrentBucket(); }
            });
        }

        function deleteSelected() {
            if (!confirm(`Permanently delete ${selectedObjectKey}?`)) return;
            s3.deleteObject({ Bucket: activeBucket, Key: selectedObjectKey }, function (err, data) {
                if (err) showToast('dsel-err', "Delete Failed: " + err.message, 'error', true); 
                else { closeDrawer(); refreshCurrentBucket(); }
            });
        }

        function toggleFileSelection(key, isChecked) { isChecked ? selectedFiles.add(key) : selectedFiles.delete(key); if (!isChecked) document.getElementById('selectAllCheckbox').checked = false; updateDrawerForSelection(); }
        function toggleAllFiles(checkbox) { const isChecked = checkbox.checked; document.querySelectorAll('.file-checkbox').forEach(cb => { cb.checked = isChecked; if(isChecked) selectedFiles.add(cb.closest('.object-row').getAttribute('data-key')); }); updateDrawerForSelection(); }
        function filterBuckets() { const term = document.getElementById('bucketSearch').value.toLowerCase(); document.querySelectorAll('.bucket-item').forEach(item => item.style.display = item.getAttribute('data-bucket').includes(term) ? 'block' : 'none'); }
        function filterObjects() { const term = document.getElementById('objectSearch').value.toLowerCase(); document.querySelectorAll('.object-row').forEach(item => item.style.display = item.getAttribute('data-key').toLowerCase().includes(term) ? 'flex' : 'none'); }
        function closeDrawer() { document.getElementById('objectDetailsDrawer').classList.add('hidden'); }
        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); document.getElementById('previewFrame').src = ''; }
        function logout() { localStorage.clear(); window.location.href = window.location.origin + window.location.pathname; }
        function showError(m) { const e = document.getElementById('loginError'); e.innerText = m; e.classList.remove('hidden'); }
        
        async function openTeamManager() {
            document.getElementById('teamModal').classList.remove('hidden');
            document.getElementById('teamModal').classList.add('flex');
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500 animate-pulse">Loading team registry...</td></tr>`;
            try {
                const res = await fetch(localStorage.getItem('bv_endpoint').replace('-api', '-admin') + '/api/employees/list', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('bv_secret') } });
                const employees = await res.json();
                tbody.innerHTML = '';
                for (const [key, emp] of Object.entries(employees)) {
                    let roleColor = emp.role === 'admin' ? 'bg-red-900/50 text-red-400' : emp.role === 'readwrite' ? 'bg-green-900/50 text-green-400' : 'bg-blue-900/50 text-blue-400';
                    tbody.innerHTML += `<tr class="border-b border-gray-800 hover:bg-gray-800/50"><td class="px-6 py-4 font-bold text-white">${emp.name}</td><td class="px-6 py-4"><span class="${roleColor} px-2 py-1 rounded text-[10px] uppercase tracking-wider font-bold">${emp.role || 'readwrite'}</span></td><td class="px-6 py-4 font-mono text-[10px] text-gray-500">${emp.access_key}</td><td class="px-6 py-4 text-right"><button onclick="revokeEmployee('${emp.access_key}')" class="text-xs font-bold text-red-500 border border-red-900/40 hover:text-white bg-red-900/10 hover:bg-red-600 px-4 py-1.5 rounded transition-colors">Revoke</button></td></tr>`;
                }
            } catch (error) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-red-500">Failed to load team data.</td></tr>`; }
        }

        async function revokeEmployee(accessKey) {
            if (!confirm("Permanently revoke this user's access?")) return;
            const res = await fetch(localStorage.getItem('bv_endpoint').replace('-api', '-admin') + '/api/employees/revoke', { method: 'POST', headers: { 'Authorization': 'Bearer ' + localStorage.getItem('bv_secret'), 'Content-Type': 'application/json' }, body: JSON.stringify({ access_key: accessKey }) });
            if (res.ok) { showToast('rev-ok', 'Access revoked.', 'success', true); openTeamManager(); } 
            else showToast('rev-err', 'Failed to revoke.', 'error', true);
        }

        function shareSelected() {
            const url = s3.getSignedUrl('getObject', { Bucket: activeBucket, Key: selectedObjectKey, Expires: 604800 });
            navigator.clipboard.writeText(url).then(() => showToast('share-ok', 'Link copied to clipboard!', 'success', true)).catch(err => prompt("Copy this link manually:", url));
        }

        function previewSelected() {
            const ct = document.getElementById('drawerContentType').innerText;
            const viewable = ['application/pdf', 'text/plain', 'text/csv', 'video/mp4', 'video/webm', 'audio/mpeg'];
            if (!ct.startsWith('image/') && !viewable.includes(ct) && !ct.startsWith('text/')) { alert(`Cannot preview files of type '${ct}'. Downloading instead.`); downloadSelected(); return; }
            const url = s3.getSignedUrl('getObject', { Bucket: activeBucket, Key: selectedObjectKey, Expires: 3600, ResponseContentType: ct, ResponseContentDisposition: 'inline' });
            if (ct.startsWith('image/')) { document.getElementById('previewImage').src = url; document.getElementById('previewImage').classList.remove('hidden'); document.getElementById('previewFrame').classList.add('hidden'); } 
            else { document.getElementById('previewFrame').src = url; document.getElementById('previewFrame').classList.remove('hidden'); document.getElementById('previewImage').classList.add('hidden'); }
            document.getElementById('previewModal').classList.remove('hidden'); document.getElementById('previewModal').classList.add('flex');
        }

        function downloadSelected() { window.location.href = s3.getSignedUrl('getObject', { Bucket: activeBucket, Key: selectedObjectKey, Expires: 60, ResponseContentDisposition: `attachment; filename="${selectedObjectKey}"` }); }
        function tagsSelected() { alert('Object Tagging API requires additional IAM policy setup. Coming soon!'); }
    </script>
</body>
</html>
